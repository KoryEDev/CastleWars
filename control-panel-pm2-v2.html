<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Castle Wars - Admin Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: #0a0e27;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Login Screen */
        #loginScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
        }

        .login-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 400px;
        }

        .login-container h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            background: linear-gradient(45deg, #ffd700, #ffed4b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-size: 14px;
            color: #aaa;
        }

        .form-group input {
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 255, 255, 0.15);
        }

        .login-button {
            padding: 14px;
            background: linear-gradient(45deg, #ffd700, #ffed4b);
            border: none;
            border-radius: 8px;
            color: #0a0e27;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
        }

        .login-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: #ff6b6b;
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        /* Main App */
        #mainApp {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
            background: linear-gradient(45deg, #ffd700, #ffed4b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .logout-button {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.02);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .nav-section {
            margin-bottom: 30px;
        }

        .nav-title {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            margin-bottom: 5px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: #aaa;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(255, 215, 0, 0.1);
            color: #ffd700;
            border-color: rgba(255, 215, 0, 0.3);
        }

        .nav-icon {
            font-size: 18px;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.01);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-title {
            font-size: 28px;
            margin-bottom: 30px;
            font-weight: 600;
        }

        /* Server Cards */
        .server-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .server-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .server-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .server-name {
            font-size: 22px;
            font-weight: 600;
        }

        .server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-online {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-stopped {
            background: rgba(255, 152, 0, 0.2);
            color: #FF9800;
            border: 1px solid rgba(255, 152, 0, 0.3);
        }

        .status-errored {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .server-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }

        .server-controls {
            display: flex;
            gap: 10px;
        }

        .control-button {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .control-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .control-button.primary {
            background: rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.4);
            color: #4CAF50;
        }

        .control-button.primary:hover {
            background: rgba(76, 175, 80, 0.3);
        }

        .control-button.danger {
            background: rgba(244, 67, 54, 0.2);
            border-color: rgba(244, 67, 54, 0.4);
            color: #F44336;
        }

        .control-button.danger:hover {
            background: rgba(244, 67, 54, 0.3);
        }

        /* Quick Actions */
        .quick-actions {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .quick-actions-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #ddd;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Players */
        .players-container {
            display: grid;
            gap: 30px;
        }

        .server-players {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }

        .server-players-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .server-players-title {
            font-size: 20px;
            font-weight: 600;
        }

        .player-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 14px;
        }

        .players-list {
            display: grid;
            gap: 10px;
        }

        .player-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .player-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .player-details h4 {
            font-size: 16px;
            margin-bottom: 3px;
        }

        .player-details span {
            font-size: 13px;
            color: #888;
        }

        .player-role {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .role-owner { background: rgba(255, 215, 0, 0.2); color: #ffd700; }
        .role-admin { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .role-mod { background: rgba(156, 39, 176, 0.2); color: #9c27b0; }
        .role-player { background: rgba(96, 125, 139, 0.2); color: #607d8b; }

        .player-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .player-action-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .player-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Logs */
        .log-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .log-select {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .log-filter {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            flex: 1;
            max-width: 300px;
        }

        .log-container {
            background: #000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            height: 600px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 2px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .log-entry:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .log-timestamp {
            color: #666;
            margin-right: 10px;
        }

        .log-info { color: #888; }
        .log-error { color: #ff6b6b; background: rgba(255, 0, 0, 0.05); }
        .log-success { color: #4CAF50; }
        .log-warning { color: #ffa726; }
        
        /* Server-specific log colors */
        .log-server {
            font-weight: bold;
            margin-right: 8px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
        }
        
        .log-server-pvp {
            background: rgba(255, 87, 34, 0.2);
            color: #ff5722;
        }
        
        .log-server-pve {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }
        
        .log-server-gui {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
        }

        /* PvE Management */
        .pve-container {
            display: grid;
            gap: 25px;
        }

        .pve-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }

        .pve-section h3 {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .wave-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .wave-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .party-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .party-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .party-card:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .party-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .party-name {
            font-weight: 600;
            font-size: 16px;
        }

        .party-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-open { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .status-closed { background: rgba(255, 152, 0, 0.2); color: #FF9800; }
        .status-ingame { background: rgba(33, 150, 243, 0.2); color: #2196F3; }

        .party-members {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .party-leader {
            font-size: 14px;
            color: #888;
        }

        /* Commands */
        .commands-container {
            display: grid;
            gap: 30px;
        }

        .command-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
        }

        .command-section h3 {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .command-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .command-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .command-card h4 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #ffd700;
        }

        .command-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .command-inputs input,
        .command-inputs select {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .command-inputs input[type="number"] {
            max-width: 100px;
        }

        .command-inputs button {
            min-width: 100px;
        }

        .custom-command {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .custom-command input {
            flex: 2;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .custom-command select {
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
        }

        /* System */
        .system-info {
            display: grid;
            gap: 25px;
        }

        .system-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }

        .system-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .system-action-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .system-action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .system-action-icon {
            font-size: 36px;
            margin-bottom: 15px;
        }

        .system-action-title {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .system-action-desc {
            font-size: 14px;
            color: #888;
            margin-bottom: 15px;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffd700;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Players Section */
        .players-container {
            display: grid;
            gap: 20px;
        }
        
        .server-players {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
        }
        
        .server-players-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .server-players-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .player-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .players-list {
            display: grid;
            gap: 10px;
        }
        
        .player-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .player-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .player-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ffd700, #ffed4b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #0a0e27;
            font-size: 18px;
        }
        
        .player-details {
            flex: 1;
        }
        
        .player-details h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        
        .player-details span {
            font-size: 14px;
            color: #888;
        }
        
        .player-role {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .role-player {
            background: rgba(189, 189, 189, 0.2);
            color: #bdbdbd;
        }
        
        .role-vip {
            background: rgba(155, 39, 176, 0.2);
            color: #9b27b0;
        }
        
        .role-mod {
            background: rgba(33, 150, 243, 0.2);
            color: #2196f3;
        }
        
        .role-admin {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        
        .role-owner {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
        }
        
        .player-actions {
            display: flex;
            gap: 8px;
        }
        
        .player-action-btn {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .player-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Mini Log Viewer */
        #miniLogViewer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 200px;
            min-width: 200px;
            min-height: 100px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            overflow: hidden;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            resize: both;
            display: flex;
            flex-direction: column;
        }

        #miniLogViewer.hidden {
            display: none;
        }

        .mini-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: move;
            user-select: none;
            background: rgba(0, 0, 0, 0.5);
        }

        .mini-log-title {
            color: #ffd700;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
        }

        .mini-log-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .mini-log-resize {
            cursor: pointer;
            color: #888;
            font-size: 14px;
            padding: 0 5px;
        }

        .mini-log-resize:hover {
            color: #fff;
        }

        .mini-log-close {
            cursor: pointer;
            color: #888;
            font-size: 16px;
            padding: 0 5px;
        }

        .mini-log-close:hover {
            color: #fff;
        }

        #miniLogContent {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .mini-log-entry {
            margin-bottom: 2px;
            padding: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Resize handle styling */
        #miniLogViewer::-webkit-resizer {
            background: transparent;
        }

        #miniLogViewer::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, rgba(255, 255, 255, 0.2) 50%);
            pointer-events: auto;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .server-grid {
                grid-template-columns: 1fr;
            }
            
            .server-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            #miniLogViewer {
                width: 300px;
                height: 150px;
                bottom: 10px;
                right: 10px;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            .content {
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            #miniLogViewer {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h1>Castle Wars Admin</h1>
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="password">Admin Password</label>
                    <input type="password" id="password" name="password" required autofocus>
                </div>
                <button type="submit" class="login-button" id="loginButton">Login</button>
                <div class="error-message" id="errorMessage"></div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp">
        <header class="header">
            <h1>Castle Wars Control Panel</h1>
            <div class="header-right">
                <div class="connection-status">
                    <div class="status-dot"></div>
                    <span>Connected</span>
                </div>
                <button class="logout-button" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="container">
            <nav class="sidebar">
                <div class="nav-section">
                    <div class="nav-title">Main</div>
                    <a class="nav-item active" onclick="showTab(event, 'dashboard')">
                        <span class="nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </a>
                    <a class="nav-item" onclick="showTab(event, 'players')">
                        <span class="nav-icon">üë•</span>
                        <span>Players</span>
                    </a>
                    <a class="nav-item" onclick="showTab(event, 'logs')">
                        <span class="nav-icon">üìú</span>
                        <span>Logs</span>
                    </a>
                    <a class="nav-item" onclick="showTab(event, 'commands')">
                        <span class="nav-icon">‚ö°</span>
                        <span>Commands</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">Game Modes</div>
                    <a class="nav-item" onclick="showTab(event, 'pve')">
                        <span class="nav-icon">üõ°Ô∏è</span>
                        <span>PvE Manager</span>
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-title">System</div>
                    <a class="nav-item" onclick="showTab(event, 'system')">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        <span>System</span>
                    </a>
                </div>
            </nav>

            <main class="content">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content active">
                    <h2 class="page-title">Dashboard</h2>
                    
                    <div class="server-grid" id="serverGrid">
                        <!-- Server cards will be dynamically inserted -->
                    </div>

                    <div class="quick-actions">
                        <h3 class="quick-actions-title">Quick Actions</h3>
                        <div class="quick-actions-grid">
                            <button class="control-button primary" onclick="pullUpdates()">
                                <span style="margin-right: 8px;">üì•</span>
                                Pull Updates from GitHub
                            </button>
                            <button class="control-button" onclick="restartAll()">
                                <span style="margin-right: 8px;">üîÑ</span>
                                Restart All Servers
                            </button>
                            <button class="control-button" onclick="showLogs()">
                                <span style="margin-right: 8px;">üìã</span>
                                View Recent Logs
                            </button>
                            <button class="control-button danger" onclick="stopAll()">
                                <span style="margin-right: 8px;">‚èπÔ∏è</span>
                                Stop All Servers
                            </button>
                            <button class="control-button" onclick="restartGUI()">
                                <span style="margin-right: 8px;">üîß</span>
                                Restart GUI
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Players Tab -->
                <div id="players" class="tab-content">
                    <h2 class="page-title">Online Players</h2>
                    <div class="players-container" id="playersContainer">
                        <!-- Player lists will be dynamically inserted -->
                    </div>
                </div>

                <!-- Logs Tab -->
                <div id="logs" class="tab-content">
                    <h2 class="page-title">Server Logs</h2>
                    <div class="log-controls">
                        <input type="text" class="log-filter" placeholder="Filter logs..." onkeyup="filterLogs(event)" style="flex: 1;">
                        <button class="control-button" onclick="clearAllLogs()">Clear All</button>
                        <button class="control-button" onclick="downloadLogs()">Download</button>
                    </div>
                    <div class="log-container" id="logContainer">
                        <!-- Logs will be dynamically inserted -->
                    </div>
                </div>

                <!-- Commands Tab -->
                <div id="commands" class="tab-content">
                    <h2 class="page-title">Admin Commands</h2>
                    <div class="commands-container">
                        <div class="command-section">
                            <h3>Player Management</h3>
                            <div class="command-grid">
                                <div class="command-card">
                                    <h4>Teleport Player</h4>
                                    <div class="command-inputs">
                                        <input type="text" id="tp-from" placeholder="From player">
                                        <input type="text" id="tp-to" placeholder="To player">
                                        <button class="control-button primary" onclick="executeTP()">Teleport</button>
                                    </div>
                                </div>
                                <div class="command-card">
                                    <h4>Give Items</h4>
                                    <div class="command-inputs">
                                        <input type="text" id="give-player" placeholder="Player">
                                        <select id="give-item">
                                            <option value="wood">Wood</option>
                                            <option value="stone">Stone</option>
                                            <option value="metal">Metal</option>
                                            <option value="gold">Gold</option>
                                            <option value="pistol">Pistol</option>
                                            <option value="smg">SMG</option>
                                            <option value="shotgun">Shotgun</option>
                                            <option value="sniper">Sniper</option>
                                        </select>
                                        <input type="number" id="give-amount" placeholder="Amount" value="1" min="1">
                                        <button class="control-button primary" onclick="executeGive()">Give</button>
                                    </div>
                                </div>
                                <div class="command-card">
                                    <h4>Change Role</h4>
                                    <div class="command-inputs">
                                        <input type="text" id="role-player" placeholder="Player">
                                        <select id="role-type">
                                            <option value="player">Player</option>
                                            <option value="vip">VIP</option>
                                            <option value="mod">Moderator</option>
                                            <option value="admin">Admin</option>
                                            <option value="owner">Owner</option>
                                        </select>
                                        <select id="role-server">
                                            <option value="pvp">PvP</option>
                                            <option value="pve">PvE</option>
                                        </select>
                                        <button class="control-button primary" onclick="executeRole()">Change</button>
                                    </div>
                                </div>
                                <div class="command-card">
                                    <h4>Give Gold</h4>
                                    <div class="command-inputs">
                                        <input type="text" id="gold-player" placeholder="Player">
                                        <input type="number" id="gold-amount" placeholder="Amount" value="100" min="1">
                                        <button class="control-button primary" onclick="executeGold()">Give Gold</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="command-section">
                            <h3>Server Commands</h3>
                            <div class="command-grid">
                                <div class="command-card">
                                    <h4>Broadcast Message</h4>
                                    <div class="command-inputs">
                                        <select id="broadcast-server">
                                            <option value="all">All Servers</option>
                                            <option value="pvp">PvP Only</option>
                                            <option value="pve">PvE Only</option>
                                        </select>
                                        <input type="text" id="broadcast-message" placeholder="Message" style="flex: 2;">
                                        <button class="control-button primary" onclick="executeBroadcast()">Send</button>
                                    </div>
                                </div>
                                <div class="command-card">
                                    <h4>Kill Player</h4>
                                    <div class="command-inputs">
                                        <input type="text" id="kill-player" placeholder="Player">
                                        <button class="control-button danger" onclick="executeKill()">Kill</button>
                                    </div>
                                </div>
                                <div class="command-card">
                                    <h4>Clear Inventory</h4>
                                    <div class="command-inputs">
                                        <input type="text" id="clear-player" placeholder="Player">
                                        <button class="control-button danger" onclick="executeClearInv()">Clear</button>
                                    </div>
                                </div>
                                <div class="command-card">
                                    <h4>Toggle Fly Mode</h4>
                                    <div class="command-inputs">
                                        <input type="text" id="fly-player" placeholder="Player (or self)">
                                        <button class="control-button primary" onclick="executeFly()">Toggle</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="command-section">
                            <h3>Custom Command</h3>
                            <div class="custom-command">
                                <input type="text" id="custom-command" placeholder="Enter command (e.g., /tp player1 player2)">
                                <select id="custom-server">
                                    <option value="pvp">PvP Server</option>
                                    <option value="pve">PvE Server</option>
                                </select>
                                <button class="control-button primary" onclick="executeCustom()">Execute</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PvE Tab -->
                <div id="pve" class="tab-content">
                    <h2 class="page-title">PvE Management</h2>
                    <div class="pve-container">
                        <div class="pve-section">
                            <h3>Wave Information</h3>
                            <div class="wave-info" id="waveInfo">
                                <div class="wave-stat">
                                    <div class="stat-label">Current Wave</div>
                                    <div class="stat-value" id="currentWave">-</div>
                                </div>
                                <div class="wave-stat">
                                    <div class="stat-label">Wave Status</div>
                                    <div class="stat-value" id="waveStatus">-</div>
                                </div>
                                <div class="wave-stat">
                                    <div class="stat-label">NPCs Alive</div>
                                    <div class="stat-value" id="npcsAlive">-</div>
                                </div>
                                <div class="wave-stat">
                                    <div class="stat-label">Team Lives</div>
                                    <div class="stat-value" id="teamLives">-</div>
                                </div>
                            </div>
                            <div class="server-controls">
                                <button class="control-button primary" onclick="startWave()">Start Wave</button>
                                <button class="control-button danger" onclick="endWave()">End Wave</button>
                                <button class="control-button" onclick="resetPvE()">Reset Game</button>
                            </div>
                        </div>

                        <div class="pve-section">
                            <h3>Active Parties</h3>
                            <div class="party-grid" id="partyGrid">
                                <!-- Parties will be dynamically inserted -->
                            </div>
                        </div>

                        <div class="pve-section">
                            <h3>NPCs</h3>
                            <div id="npcInfo">
                                <!-- NPC info will be dynamically inserted -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Tab -->
                <div id="system" class="tab-content">
                    <h2 class="page-title">System Management</h2>
                    <div class="system-info">
                        <div class="system-section">
                            <h3>Server Actions</h3>
                            <div class="system-actions">
                                <div class="system-action-card">
                                    <div class="system-action-icon">üîÑ</div>
                                    <div class="system-action-title">Update Servers</div>
                                    <div class="system-action-desc">Pull latest code and restart</div>
                                    <button class="control-button primary" onclick="updateAndRestart()">Execute</button>
                                </div>
                                <div class="system-action-card">
                                    <div class="system-action-icon">üíæ</div>
                                    <div class="system-action-title">Backup Data</div>
                                    <div class="system-action-desc">Backup world and player data</div>
                                    <button class="control-button" onclick="backupData()">Backup Now</button>
                                </div>
                                <div class="system-action-card">
                                    <div class="system-action-icon">üßπ</div>
                                    <div class="system-action-title">Clean Logs</div>
                                    <div class="system-action-desc">Remove old log files</div>
                                    <button class="control-button" onclick="cleanLogs()">Clean</button>
                                </div>
                                <div class="system-action-card">
                                    <div class="system-action-icon">üìä</div>
                                    <div class="system-action-title">PM2 Status</div>
                                    <div class="system-action-desc">View detailed PM2 info</div>
                                    <button class="control-button" onclick="showPM2Status()">View</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="system-section">
                            <h3>System Information</h3>
                            <div id="systemStats">
                                <!-- System stats will be dynamically inserted -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Mini Log Viewer -->
    <div id="miniLogViewer" class="hidden">
        <div class="mini-log-header" onmousedown="startDrag(event)">
            <span class="mini-log-title">Recent Activity</span>
            <div class="mini-log-controls">
                <span class="mini-log-close" onclick="toggleMiniLog()">√ó</span>
            </div>
        </div>
        <div id="miniLogContent">
            <!-- Mini logs will be inserted here -->
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket = null;
        let authenticated = false;
        let serverStatuses = {};
        let allLogs = []; // Unified log array
        let logFilter = '';
        let miniLogVisible = true;

        // Check if already authenticated
        checkAuth();
        
        // Load persistent logs from localStorage
        loadPersistedLogs();

        async function checkAuth() {
            try {
                const response = await fetch('/auth-status');
                const data = await response.json();
                if (data.authenticated) {
                    showMainApp();
                }
            } catch (err) {
                console.error('Auth check failed:', err);
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const button = document.getElementById('loginButton');
            const errorMsg = document.getElementById('errorMessage');
            const password = document.getElementById('password').value;

            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> Logging in...';
            errorMsg.style.display = 'none';

            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    showMainApp();
                } else {
                    const data = await response.json();
                    errorMsg.textContent = data.error || 'Login failed';
                    errorMsg.style.display = 'block';
                    button.disabled = false;
                    button.textContent = 'Login';
                }
            } catch (err) {
                errorMsg.textContent = 'Network error';
                errorMsg.style.display = 'block';
                button.disabled = false;
                button.textContent = 'Login';
            }
        }

        function showMainApp() {
            authenticated = true;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            initializeSocket();
            showMiniLog(); // Show mini log when authenticated
            restoreMiniLogPosition(); // Restore saved position
            initResizeObserver(); // Watch for resize
        }

        function showMiniLog() {
            const viewer = document.getElementById('miniLogViewer');
            if (viewer && authenticated) {
                viewer.classList.remove('hidden');
                miniLogVisible = true;
            }
        }

        function toggleMiniLog() {
            const viewer = document.getElementById('miniLogViewer');
            viewer.classList.toggle('hidden');
            miniLogVisible = !miniLogVisible;
        }

        // Dragging functionality for mini log
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let logStartX = 0;
        let logStartY = 0;

        function startDrag(e) {
            const miniLog = document.getElementById('miniLogViewer');
            isDragging = true;
            
            // Get initial mouse position
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            
            // Get initial log position
            const rect = miniLog.getBoundingClientRect();
            logStartX = rect.left;
            logStartY = rect.top;
            
            // Add mouse move and up listeners to document
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
            
            // Prevent text selection while dragging
            e.preventDefault();
        }

        function onDrag(e) {
            if (!isDragging) return;
            
            const miniLog = document.getElementById('miniLogViewer');
            
            // Calculate new position
            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;
            
            let newLeft = logStartX + deltaX;
            let newTop = logStartY + deltaY;
            
            // Keep within viewport bounds
            const rect = miniLog.getBoundingClientRect();
            const maxX = window.innerWidth - rect.width;
            const maxY = window.innerHeight - rect.height;
            
            newLeft = Math.max(0, Math.min(newLeft, maxX));
            newTop = Math.max(0, Math.min(newTop, maxY));
            
            // Apply new position
            miniLog.style.left = newLeft + 'px';
            miniLog.style.top = newTop + 'px';
            miniLog.style.right = 'auto';
            miniLog.style.bottom = 'auto';
        }

        function stopDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
            
            // Save position to localStorage
            const miniLog = document.getElementById('miniLogViewer');
            const position = {
                left: miniLog.style.left,
                top: miniLog.style.top,
                width: miniLog.style.width,
                height: miniLog.style.height
            };
            localStorage.setItem('miniLogPosition', JSON.stringify(position));
        }

        // Restore mini log position on load
        function restoreMiniLogPosition() {
            const savedPosition = localStorage.getItem('miniLogPosition');
            if (savedPosition) {
                const position = JSON.parse(savedPosition);
                const miniLog = document.getElementById('miniLogViewer');
                
                if (position.left) miniLog.style.left = position.left;
                if (position.top) miniLog.style.top = position.top;
                if (position.width) miniLog.style.width = position.width;
                if (position.height) miniLog.style.height = position.height;
                
                // Clear right/bottom to use left/top
                if (position.left) {
                    miniLog.style.right = 'auto';
                    miniLog.style.bottom = 'auto';
                }
            }
        }

        // Watch for resize and save position
        function initResizeObserver() {
            const miniLog = document.getElementById('miniLogViewer');
            const resizeObserver = new ResizeObserver(() => {
                const position = {
                    left: miniLog.style.left,
                    top: miniLog.style.top,
                    width: miniLog.offsetWidth + 'px',
                    height: miniLog.offsetHeight + 'px'
                };
                localStorage.setItem('miniLogPosition', JSON.stringify(position));
            });
            resizeObserver.observe(miniLog);
        }

        function addToMiniLog(message, type = 'info', server = 'gui') {
            // Add to unified logs
            addLogEntry({
                server,
                type,
                message,
                timestamp: new Date().toISOString()
            });
        }

        function updateMiniLogDisplay() {
            const container = document.getElementById('miniLogContent');
            if (!container || !miniLogVisible) return;
            
            // Show last 20 logs
            const recentLogs = allLogs.slice(-20).reverse();
            
            container.innerHTML = recentLogs.map(log => {
                const timestamp = new Date(log.timestamp).toLocaleTimeString();
                const serverBadge = `<span class="log-server log-server-${log.server}" style="font-size: 10px;">${log.server.toUpperCase()}</span>`;
                
                return `
                    <div class="mini-log-entry log-${log.type}">
                        <span style="color: #666; font-size: 10px;">${timestamp}</span>
                        ${serverBadge}
                        <span style="font-size: 11px;">${log.message}</span>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        function initializeSocket() {
            socket = io();

            socket.on('serverStatus', (status) => {
                // Merge status but keep player data
                for (const [id, serverData] of Object.entries(status)) {
                    if (!serverStatuses[id]) {
                        serverStatuses[id] = serverData;
                        serverStatuses[id].players = [];
                    } else {
                        // Keep existing player data
                        const players = serverStatuses[id].players;
                        serverStatuses[id] = { ...serverData, players };
                    }
                }
                updateServerCards();
                updateSystemStats();
            });

            socket.on('playerList', (data) => {
                updatePlayerList(data);
            });

            socket.on('serverLog', (data) => {
                const log = data.log;
                log.server = data.serverId;
                addLogEntry(log);
            });

            socket.on('partyList', (data) => {
                updatePartyList(data.parties);
            });

            socket.on('waveInfo', (data) => {
                updateWaveInfo(data);
            });

            socket.on('npcList', (data) => {
                updateNPCInfo(data.npcs);
            });

            socket.on('guiRestarting', (data) => {
                addToMiniLog(data.message, 'warning');
                // Longer delay before refresh to ensure GUI has restarted
                setTimeout(() => {
                    location.reload();
                }, 8000); // 8 seconds instead of 3.5
            });

            socket.on('updateAvailable', (data) => {
                addToMiniLog(data.message, 'success');
                
                // If restart time is specified, set up reload timer
                if (data.restartTime) {
                    const reloadTime = data.restartTime + 5000; // Add extra 5 seconds buffer
                    setTimeout(() => {
                        addToMiniLog('Reloading page...', 'info');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    }, reloadTime);
                }
            });
        }

        function showTab(event, tabName) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Special handling for certain tabs
            if (tabName === 'logs') {
                // Hide mini log when viewing main logs
                document.getElementById('miniLogViewer').classList.add('hidden');
                displayLogs();
            } else if (tabName === 'players') {
                displayAllPlayers();
                // Show mini log on other tabs if it was visible
                if (miniLogVisible && authenticated) {
                    document.getElementById('miniLogViewer').classList.remove('hidden');
                }
            } else {
                // Show mini log on other tabs if it was visible
                if (miniLogVisible && authenticated) {
                    document.getElementById('miniLogViewer').classList.remove('hidden');
                }
            }
        }

        function updateServerCards() {
            const grid = document.getElementById('serverGrid');
            grid.innerHTML = '';

            for (const [id, server] of Object.entries(serverStatuses)) {
                const card = createServerCard(id, server);
                grid.appendChild(card);
            }
            
            // Also update player display if on players tab
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'players') {
                displayAllPlayers();
            }
        }

        function createServerCard(id, server) {
            const card = document.createElement('div');
            card.className = 'server-card';

            const statusClass = `status-${server.status}`;
            const uptime = formatUptime(server.uptime);

            card.innerHTML = `
                <div class="server-header">
                    <div class="server-name">${server.name}</div>
                    <div class="server-status ${statusClass}">
                        <span class="status-dot">‚óè</span>
                        ${server.status.toUpperCase()}
                    </div>
                </div>
                <div class="server-stats">
                    <div class="stat-item">
                        <div class="stat-label">Players</div>
                        <div class="stat-value">${server.playerCount}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Uptime</div>
                        <div class="stat-value">${uptime}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">CPU</div>
                        <div class="stat-value">${server.cpu || 0}%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Memory</div>
                        <div class="stat-value">${server.memory || 0}MB</div>
                    </div>
                </div>
                <div class="server-controls">
                    ${server.status === 'online' ? 
                        `<button class="control-button danger" onclick="stopServer('${id}')">Stop</button>
                         <button class="control-button" onclick="restartServer('${id}')">Restart</button>` :
                        `<button class="control-button primary" onclick="startServer('${id}')">Start</button>`
                    }
                    <button class="control-button" onclick="viewServerLogs('${id}')">Logs</button>
                </div>
            `;

            return card;
        }

        function formatUptime(timestamp) {
            if (!timestamp) return 'Offline';
            
            const now = Date.now();
            const uptime = now - timestamp;
            
            const seconds = Math.floor(uptime / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days}d ${hours % 24}h`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
            return `${seconds}s`;
        }

        function updatePlayerList(data) {
            if (!data || !data.serverId || !data.players) return;
            
            // Store player data in serverStatuses
            if (serverStatuses[data.serverId]) {
                serverStatuses[data.serverId].players = data.players;
            }
            
            // Redraw all players
            displayAllPlayers();
        }
        
        function displayAllPlayers() {
            const container = document.getElementById('playersContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Create sections for each server
            for (const [serverId, serverData] of Object.entries(serverStatuses)) {
                const section = document.createElement('div');
                section.className = 'server-players';
                
                const players = serverData.players || [];
                const playerCount = players.length;
                
                // Server header with color coding
                const serverColor = serverId === 'pvp' ? '#ff5722' : '#4CAF50';
                
                section.innerHTML = `
                    <div class="server-players-header">
                        <h3 class="server-players-title" style="color: ${serverColor};">${serverData.name}</h3>
                        <span class="player-count">${playerCount} player${playerCount !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="players-list" id="players-${serverId}">
                        ${playerCount === 0 ? '<p style="color: #666;">No players online</p>' : ''}
                    </div>
                `;
                
                container.appendChild(section);
                
                // Add player items
                if (playerCount > 0) {
                    const playersList = section.querySelector(`#players-${serverId}`);
                    playersList.innerHTML = '';
                    players.forEach(player => {
                        playersList.appendChild(createPlayerItem(player, serverId));
                    });
                }
            }
        }

        function createPlayerItem(player, serverId) {
            const item = document.createElement('div');
            item.className = 'player-item';
            
            const roleClass = `role-${player.role || 'player'}`;
            const avatar = player.username.charAt(0).toUpperCase();
            
            item.innerHTML = `
                <div class="player-info">
                    <div class="player-avatar">${avatar}</div>
                    <div class="player-details">
                        <h4>${player.username}</h4>
                        <span>K: ${player.kills || 0} / D: ${player.deaths || 0}</span>
                    </div>
                    <span class="player-role ${roleClass}">${player.role || 'player'}</span>
                </div>
                <div class="player-actions">
                    <button class="player-action-btn" onclick="kickPlayer('${serverId}', '${player.username}')">Kick</button>
                    <button class="player-action-btn" onclick="banPlayer('${serverId}', '${player.username}')">Ban</button>
                    <button class="player-action-btn" onclick="mutePlayer('${serverId}', '${player.username}')">Mute</button>
                    <button class="player-action-btn" onclick="promotePlayer('${serverId}', '${player.username}')">Promote</button>
                </div>
            `;
            
            return item;
        }

        function addLogEntry(log) {
            // Add server info if not present
            if (!log.server) log.server = 'gui';
            
            allLogs.push(log);
            
            // Keep only last 2000 total logs
            if (allLogs.length > 2000) {
                allLogs.shift();
            }
            
            // Update displays
            updateMiniLogDisplay();
            displayLogs();
            
            // Save to localStorage
            savePersistedLogs();
        }

        function displayLogs() {
            const container = document.getElementById('logContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Display logs in reverse order (newest first)
            const logsToDisplay = [...allLogs].reverse();
            
            logsToDisplay.forEach(log => {
                if (logFilter && !log.message.toLowerCase().includes(logFilter.toLowerCase())) {
                    return;
                }
                
                const entry = document.createElement('div');
                entry.className = `log-entry log-${log.type}`;
                
                const timestamp = new Date(log.timestamp).toLocaleTimeString();
                const serverBadge = `<span class="log-server log-server-${log.server}">${log.server.toUpperCase()}</span>`;
                
                entry.innerHTML = `
                    <span class="log-timestamp">${timestamp}</span>
                    ${serverBadge}
                    ${log.message}
                `;
                
                container.appendChild(entry);
            });
        }

        function filterLogs(event) {
            logFilter = event.target.value;
            displayLogs();
        }


        function updateWaveInfo(data) {
            document.getElementById('currentWave').textContent = data.currentWave || '-';
            document.getElementById('waveStatus').textContent = data.isWaveActive ? 'Active' : 'Inactive';
            document.getElementById('npcsAlive').textContent = data.npcsAlive || 0;
            document.getElementById('teamLives').textContent = data.teamLives || '-';
        }

        function updatePartyList(parties) {
            const grid = document.getElementById('partyGrid');
            grid.innerHTML = '';
            
            if (!parties || parties.length === 0) {
                grid.innerHTML = '<p style="color: #666;">No active parties</p>';
                return;
            }
            
            parties.forEach(party => {
                const card = document.createElement('div');
                card.className = 'party-card';
                
                const statusClass = party.inGame ? 'status-ingame' : (party.isOpen ? 'status-open' : 'status-closed');
                const status = party.inGame ? 'In Game' : (party.isOpen ? 'Open' : 'Closed');
                
                card.innerHTML = `
                    <div class="party-header">
                        <div class="party-name">${party.name}</div>
                        <div class="party-status ${statusClass}">${status}</div>
                    </div>
                    <div class="party-members">Members: ${party.members.length}/${party.maxMembers}</div>
                    <div class="party-leader">Leader: ${party.leader}</div>
                `;
                
                grid.appendChild(card);
            });
        }

        function updateNPCInfo(npcs) {
            const container = document.getElementById('npcInfo');
            
            if (!npcs || npcs.length === 0) {
                container.innerHTML = '<p style="color: #666;">No NPCs spawned</p>';
                return;
            }
            
            const npcTypes = {};
            npcs.forEach(npc => {
                npcTypes[npc.type] = (npcTypes[npc.type] || 0) + 1;
            });
            
            container.innerHTML = `
                <div class="server-stats">
                    ${Object.entries(npcTypes).map(([type, count]) => `
                        <div class="stat-item">
                            <div class="stat-label">${type}</div>
                            <div class="stat-value">${count}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateSystemStats() {
            const container = document.getElementById('systemStats');
            
            let totalPlayers = 0;
            let totalMemory = 0;
            let totalCPU = 0;
            let onlineServers = 0;
            
            for (const server of Object.values(serverStatuses)) {
                totalPlayers += server.playerCount;
                if (server.status === 'online') {
                    onlineServers++;
                    totalMemory += server.memory || 0;
                    totalCPU += server.cpu || 0;
                }
            }
            
            container.innerHTML = `
                <div class="server-stats">
                    <div class="stat-item">
                        <div class="stat-label">Total Players</div>
                        <div class="stat-value">${totalPlayers}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Servers Online</div>
                        <div class="stat-value">${onlineServers}/${Object.keys(serverStatuses).length}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Total Memory</div>
                        <div class="stat-value">${totalMemory}MB</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg CPU</div>
                        <div class="stat-value">${onlineServers > 0 ? Math.round(totalCPU / onlineServers) : 0}%</div>
                    </div>
                </div>
            `;
        }

        // Server control functions
        async function startServer(id) {
            try {
                const response = await fetch(`/server/${id}/start`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to start server');
            } catch (err) {
                addToMiniLog('Failed to start server: ' + err.message, 'error');
            }
        }

        async function stopServer(id) {
            if (!confirm(`Stop ${serverStatuses[id].name}?`)) return;
            try {
                const response = await fetch(`/server/${id}/stop`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to stop server');
            } catch (err) {
                addToMiniLog('Failed to stop server: ' + err.message, 'error');
            }
        }

        async function restartServer(id) {
            if (!confirm(`Restart ${serverStatuses[id].name}?`)) return;
            try {
                const response = await fetch(`/server/${id}/restart`, { method: 'POST' });
                if (!response.ok) throw new Error('Failed to restart server');
            } catch (err) {
                addToMiniLog('Failed to restart server: ' + err.message, 'error');
            }
        }

        async function pullUpdates() {
            if (!confirm('Pull latest updates from GitHub?')) return;
            try {
                const response = await fetch('/git/pull', { method: 'POST' });
                const data = await response.json();
                addToMiniLog(data.output || 'Updates pulled successfully');
            } catch (err) {
                addToMiniLog('Failed to pull updates: ' + err.message, 'error');
            }
        }

        async function restartAll() {
            if (!confirm('Restart all servers?')) return;
            for (const id of Object.keys(serverStatuses)) {
                await restartServer(id);
            }
        }

        async function stopAll() {
            if (!confirm('Stop all servers?')) return;
            for (const id of Object.keys(serverStatuses)) {
                if (serverStatuses[id].status === 'online') {
                    await stopServer(id);
                }
            }
        }

        function viewServerLogs(id) {
            document.getElementById('logServerSelect').value = id;
            showTab({ target: document.querySelector('.nav-item:nth-child(3)') }, 'logs');
            switchLogServer();
        }

        function showLogs() {
            showTab({ target: document.querySelector('.nav-item:nth-child(3)') }, 'logs');
        }

        async function kickPlayer(serverId, username) {
            if (!confirm(`Kick ${username}?`)) return;
            try {
                await fetch(`/server/${serverId}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'kick', username })
                });
            } catch (err) {
                addToMiniLog('Failed to kick player: ' + err.message, 'error');
            }
        }

        async function banPlayer(serverId, username) {
            if (!confirm(`Ban ${username}? This is permanent!`)) return;
            try {
                await fetch(`/server/${serverId}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'ban', username })
                });
            } catch (err) {
                addToMiniLog('Failed to ban player: ' + err.message, 'error');
            }
        }

        // PvE controls
        async function startWave() {
            try {
                await fetch('/server/pve/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'startWave' })
                });
            } catch (err) {
                addToMiniLog('Failed to start wave: ' + err.message, 'error');
            }
        }

        async function endWave() {
            try {
                await fetch('/server/pve/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'endWave' })
                });
            } catch (err) {
                addToMiniLog('Failed to end wave: ' + err.message, 'error');
            }
        }

        async function resetPvE() {
            if (!confirm('Reset all PvE game data?')) return;
            try {
                await fetch('/server/pve/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'resetGame' })
                });
            } catch (err) {
                addToMiniLog('Failed to reset game: ' + err.message, 'error');
            }
        }

        // System functions
        async function updateAndRestart() {
            if (!confirm('This will pull updates and restart all servers. Continue?')) return;
            await pullUpdates();
            setTimeout(() => restartAll(), 2000);
        }

        function backupData() {
            addToMiniLog('Backup functionality coming soon!');
        }

        function cleanLogs() {
            addToMiniLog('Log cleaning functionality coming soon!');
        }

        function showPM2Status() {
            addToMiniLog('PM2 status viewer coming soon!');
        }

        function clearAllLogs() {
            allLogs = [];
            savePersistedLogs();
            displayLogs();
            updateMiniLogDisplay();
        }
        
        function loadPersistedLogs() {
            try {
                const saved = localStorage.getItem('castleWarsUnifiedLogs');
                if (saved) {
                    allLogs = JSON.parse(saved);
                    updateMiniLogDisplay();
                }
            } catch (err) {
                console.error('Failed to load persisted logs:', err);
            }
        }
        
        function savePersistedLogs() {
            try {
                localStorage.setItem('castleWarsUnifiedLogs', JSON.stringify(allLogs));
            } catch (err) {
                console.error('Failed to save logs:', err);
            }
        }

        function downloadLogs() {
            const content = allLogs.map(log => {
                const timestamp = new Date(log.timestamp).toISOString();
                return `[${timestamp}] [${log.server.toUpperCase()}] [${log.type.toUpperCase()}] ${log.message}`;
            }).join('\n');
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `castle-wars-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function logout() {
            await fetch('/logout', { method: 'POST' });
            location.reload();
        }

        // GUI restart handler
        async function restartGUI() {
            if (!confirm('Restart the GUI control panel? Page will refresh automatically.')) return;
            try {
                const response = await fetch('/gui/restart', { method: 'POST' });
                const data = await response.json();
                addToMiniLog(data.message);
            } catch (err) {
                addToMiniLog('Failed to restart GUI: ' + err.message, 'error');
            }
        }

        // Additional player actions
        async function mutePlayer(serverId, username) {
            if (!confirm(`Mute ${username}?`)) return;
            try {
                await fetch(`/server/${serverId}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'mute', username })
                });
            } catch (err) {
                addToMiniLog('Failed to mute player: ' + err.message, 'error');
            }
        }

        async function promotePlayer(serverId, username) {
            const role = prompt(`Promote ${username} to which role? (vip/mod/admin)`);
            if (!role) return;
            
            try {
                await fetch(`/server/${serverId}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'command', command: `/role ${username} ${role}` })
                });
            } catch (err) {
                addToMiniLog('Failed to promote player: ' + err.message, 'error');
            }
        }

        // Command tab functions
        async function executeTP() {
            const from = document.getElementById('tp-from').value;
            const to = document.getElementById('tp-to').value;
            if (!from || !to) {
                addToMiniLog('Please enter both player names');
                return;
            }
            await executeCommand('pvp', `/tp ${from} ${to}`);
        }

        async function executeGive() {
            const player = document.getElementById('give-player').value;
            const item = document.getElementById('give-item').value;
            const amount = document.getElementById('give-amount').value;
            if (!player) {
                addToMiniLog('Please enter player name');
                return;
            }
            await executeCommand('pvp', `/give ${player} ${item} ${amount}`);
        }

        async function executeRole() {
            const player = document.getElementById('role-player').value;
            const role = document.getElementById('role-type').value;
            const server = document.getElementById('role-server').value;
            if (!player) {
                addToMiniLog('Please enter player name', 'error');
                return;
            }
            await executeCommand(server, `/role ${player} ${role}`);
        }

        async function executeGold() {
            const player = document.getElementById('gold-player').value;
            const amount = document.getElementById('gold-amount').value;
            if (!player) {
                addToMiniLog('Please enter player name');
                return;
            }
            await executeCommand('pvp', `/gold ${player} ${amount}`);
        }

        async function executeBroadcast() {
            const server = document.getElementById('broadcast-server').value;
            const message = document.getElementById('broadcast-message').value;
            if (!message) {
                addToMiniLog('Please enter a message');
                return;
            }
            
            if (server === 'all') {
                await executeCommand('pvp', `/broadcast ${message}`);
                await executeCommand('pve', `/broadcast ${message}`);
            } else {
                await executeCommand(server, `/broadcast ${message}`);
            }
        }

        async function executeKill() {
            const player = document.getElementById('kill-player').value;
            if (!player) {
                addToMiniLog('Please enter player name');
                return;
            }
            await executeCommand('pvp', `/kill ${player}`);
        }

        async function executeClearInv() {
            const player = document.getElementById('clear-player').value;
            if (!player) {
                addToMiniLog('Please enter player name');
                return;
            }
            await executeCommand('pvp', `/clearinv ${player}`);
        }

        async function executeFly() {
            const player = document.getElementById('fly-player').value || 'self';
            await executeCommand('pvp', player === 'self' ? '/fly' : `/fly ${player}`);
        }

        async function executeCustom() {
            const command = document.getElementById('custom-command').value;
            const server = document.getElementById('custom-server').value;
            if (!command) {
                addToMiniLog('Please enter a command');
                return;
            }
            await executeCommand(server, command);
        }

        async function executeCommand(serverId, command) {
            try {
                const response = await fetch(`/server/${serverId}/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'command', command })
                });
                
                if (!response.ok) {
                    throw new Error('Command failed');
                }
                
                // Clear the input fields for custom command
                if (document.getElementById('custom-command').value === command) {
                    document.getElementById('custom-command').value = '';
                }
                
                // Show success feedback
                const commandDisplay = command.length > 50 ? command.substring(0, 50) + '...' : command;
                addLogEntry({
                    server: serverId,
                    type: 'success',
                    message: `Command executed: ${commandDisplay}`,
                    timestamp: new Date().toISOString()
                });
            } catch (err) {
                addToMiniLog('Failed to execute command: ' + err.message, 'error');
            }
        }

        // Backup functionality implementation
        async function backupData() {
            if (!confirm('Create a backup of world and player data?')) return;
            
            try {
                const response = await fetch('/system/backup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (data.success) {
                    addToMiniLog(`Backup created successfully!\nLocation: ${data.filename}`);
                } else {
                    throw new Error(data.error || 'Backup failed');
                }
            } catch (err) {
                addToMiniLog('Failed to create backup: ' + err.message, 'error');
            }
        }
    </script>
</body>
</html>
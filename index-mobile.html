<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Castle Wars: Mobile</title>
  <link rel="icon" type="image/png" href="/assets/favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      width: 100vw;
      height: 100vh;
      background-color: #000000;
      overflow: hidden;
      position: fixed;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }
    
    #game {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    /* Hide ALL desktop UI elements */
    #gameUI, #bottom-ui-panel, .game-ui-panel, #inventory-panel, #party-panel, #chat-container {
      display: none !important;
    }
    
    /* Mobile UI overlay */
    #mobile-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      display: none; /* Hidden by default, shown when game starts */
    }
    
    #mobile-overlay.active {
      display: block;
    }
    
    /* Top stats bar */
    #mobile-stats {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0));
      padding: 10px;
      padding-top: env(safe-area-inset-top, 10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
    }
    
    .stat-group {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0,0,0,0.4);
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 14px;
      color: white;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .stat-icon {
      font-size: 18px;
    }
    
    #health-bar {
      width: 80px;
      height: 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }
    
    #health-fill {
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      background: #ff6b6b;
      transition: width 0.3s;
      width: 100%;
    }
    
    /* Virtual joystick */
    #joystick-area {
      position: absolute;
      left: 20px;
      bottom: 20px;
      bottom: calc(20px + env(safe-area-inset-bottom, 0px));
      width: 140px;
      height: 140px;
      pointer-events: auto;
    }
    
    #joystick-base {
      position: absolute;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    
    #joystick-stick {
      position: absolute;
      width: 50px;
      height: 50px;
      background: radial-gradient(circle, rgba(255,255,255,0.8), rgba(255,255,255,0.4));
      border-radius: 50%;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      pointer-events: none;
    }
    
    /* Action buttons */
    #action-buttons {
      position: absolute;
      right: 20px;
      bottom: 20px;
      bottom: calc(20px + env(safe-area-inset-bottom, 0px));
      pointer-events: auto;
    }
    
    .action-btn {
      position: absolute;
      width: 65px;
      height: 65px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: bold;
      border: 2px solid;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: transform 0.1s, box-shadow 0.1s;
      cursor: pointer;
    }
    
    .action-btn:active {
      transform: scale(0.9);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    #shoot-btn {
      right: 0;
      bottom: 80px;
      background: rgba(255, 100, 100, 0.7);
      border-color: #ff6666;
      color: white;
    }
    
    #jump-btn {
      right: 0;
      bottom: 0;
      background: rgba(100, 150, 255, 0.7);
      border-color: #6699ff;
      color: white;
      font-size: 24px;
    }
    
    #build-btn {
      right: 80px;
      bottom: 0;
      background: rgba(100, 255, 100, 0.7);
      border-color: #66ff66;
      color: white;
      font-size: 24px;
    }
    
    /* Quick action buttons */
    #quick-actions {
      position: absolute;
      top: 70px;
      right: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: auto;
    }
    
    .quick-btn {
      width: 45px;
      height: 45px;
      background: rgba(0,0,0,0.7);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .quick-btn:active {
      background: rgba(255,255,255,0.2);
    }
    
    /* Mobile chat (hidden by default) */
    #mobile-chat {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 200px;
      background: rgba(0,0,0,0.9);
      transform: translateY(100%);
      transition: transform 0.3s;
      pointer-events: auto;
      display: none;
    }
    
    #mobile-chat.active {
      transform: translateY(0);
    }
    
    /* Weapon indicator */
    #weapon-indicator {
      position: absolute;
      bottom: 160px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      padding: 5px 15px;
      border-radius: 20px;
      color: white;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      pointer-events: none;
    }
    
    /* Landscape adjustments */
    @media screen and (orientation: landscape) and (max-height: 500px) {
      #mobile-stats {
        padding: 5px;
      }
      
      .stat-group {
        font-size: 12px;
        padding: 3px 8px;
      }
      
      #joystick-area {
        width: 120px;
        height: 120px;
        left: 10px;
        bottom: 10px;
      }
      
      .action-btn {
        width: 55px;
        height: 55px;
        font-size: 24px;
      }
      
      #shoot-btn {
        bottom: 65px;
      }
      
      #build-btn {
        right: 65px;
      }
    }
    
    /* iPhone X+ safe areas */
    @supports (padding: max(0px)) {
      #mobile-stats {
        padding-left: max(10px, env(safe-area-inset-left));
        padding-right: max(10px, env(safe-area-inset-right));
      }
      
      #joystick-area {
        left: max(20px, env(safe-area-inset-left));
      }
      
      #action-buttons {
        right: max(20px, env(safe-area-inset-right));
      }
    }
  </style>
</head>
<body>
  <div id="game"></div>
  
  <div id="mobile-overlay">
    <!-- Top stats bar -->
    <div id="mobile-stats">
      <div class="stat-group">
        <span class="stat-icon">‚ù§Ô∏è</span>
        <div id="health-bar">
          <div id="health-fill"></div>
        </div>
        <span id="health-text">100</span>
      </div>
      
      <div class="stat-group">
        <span class="stat-icon">üî´</span>
        <span id="weapon-name">FIST</span>
      </div>
      
      <div class="stat-group">
        <span class="stat-icon">üîµ</span>
        <span id="ammo-count">‚àû</span>
      </div>
    </div>
    
    <!-- Virtual joystick -->
    <div id="joystick-area">
      <div id="joystick-base"></div>
      <div id="joystick-stick"></div>
    </div>
    
    <!-- Action buttons -->
    <div id="action-buttons">
      <div id="shoot-btn" class="action-btn">üî´</div>
      <div id="jump-btn" class="action-btn">‚¨ÜÔ∏è</div>
      <div id="build-btn" class="action-btn">üèóÔ∏è</div>
    </div>
    
    <!-- Quick actions -->
    <div id="quick-actions">
      <div id="inventory-btn" class="quick-btn">üéí</div>
      <div id="chat-btn" class="quick-btn">üí¨</div>
    </div>
    
    <!-- Weapon indicator -->
    <div id="weapon-indicator" style="display: none;">
      <span>TAP TO SHOOT</span>
    </div>
  </div>
  
  <script type="module">
    // Mobile controls manager
    class MobileControls {
      constructor() {
        this.movement = { x: 0, y: 0 };
        this.buttons = { shoot: false, jump: false, build: false };
        this.joystick = { active: false, startX: 0, startY: 0 };
        this.maxJoystickDistance = 50;
        
        this.init();
      }
      
      init() {
        this.setupJoystick();
        this.setupActionButtons();
        this.setupQuickActions();
        this.setupTouchAiming();
        this.startUpdateLoop();
      }
      
      setupJoystick() {
        const joystickArea = document.getElementById('joystick-area');
        const joystickStick = document.getElementById('joystick-stick');
        
        const handleStart = (e) => {
          e.preventDefault();
          const touch = e.touches ? e.touches[0] : e;
          const rect = joystickArea.getBoundingClientRect();
          
          this.joystick.active = true;
          this.joystick.startX = touch.clientX - rect.left;
          this.joystick.startY = touch.clientY - rect.top;
        };
        
        const handleMove = (e) => {
          if (!this.joystick.active) return;
          e.preventDefault();
          
          const touch = e.touches ? e.touches[0] : e;
          const rect = joystickArea.getBoundingClientRect();
          
          const currentX = touch.clientX - rect.left;
          const currentY = touch.clientY - rect.top;
          
          let deltaX = currentX - this.joystick.startX;
          let deltaY = currentY - this.joystick.startY;
          
          const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
          
          if (distance > this.maxJoystickDistance) {
            const angle = Math.atan2(deltaY, deltaX);
            deltaX = Math.cos(angle) * this.maxJoystickDistance;
            deltaY = Math.sin(angle) * this.maxJoystickDistance;
          }
          
          joystickStick.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
          
          this.movement.x = deltaX / this.maxJoystickDistance;
          this.movement.y = deltaY / this.maxJoystickDistance;
        };
        
        const handleEnd = () => {
          this.joystick.active = false;
          joystickStick.style.transform = 'translate(0, 0)';
          this.movement = { x: 0, y: 0 };
        };
        
        joystickArea.addEventListener('touchstart', handleStart);
        joystickArea.addEventListener('touchmove', handleMove);
        joystickArea.addEventListener('touchend', handleEnd);
        joystickArea.addEventListener('touchcancel', handleEnd);
      }
      
      setupActionButtons() {
        // Shoot button
        const shootBtn = document.getElementById('shoot-btn');
        shootBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          this.buttons.shoot = true;
        });
        shootBtn.addEventListener('touchend', (e) => {
          e.preventDefault();
          this.buttons.shoot = false;
        });
        
        // Jump button  
        const jumpBtn = document.getElementById('jump-btn');
        jumpBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          this.buttons.jump = true;
        });
        jumpBtn.addEventListener('touchend', (e) => {
          e.preventDefault();
          this.buttons.jump = false;
        });
        
        // Build button (toggle)
        const buildBtn = document.getElementById('build-btn');
        buildBtn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          this.buttons.build = !this.buttons.build;
          buildBtn.style.background = this.buttons.build ? 
            'rgba(100, 255, 100, 1)' : 'rgba(100, 255, 100, 0.7)';
        });
      }
      
      setupQuickActions() {
        document.getElementById('inventory-btn').addEventListener('touchstart', (e) => {
          e.preventDefault();
          if (window.gameScene && window.gameScene.inventoryUI) {
            window.gameScene.inventoryUI.toggle();
          }
        });
        
        document.getElementById('chat-btn').addEventListener('touchstart', (e) => {
          e.preventDefault();
          this.toggleMobileChat();
        });
      }
      
      toggleMobileChat() {
        const existingChat = document.getElementById('mobile-chat-overlay');
        
        if (existingChat) {
          existingChat.remove();
          return;
        }
        
        const chatOverlay = document.createElement('div');
        chatOverlay.id = 'mobile-chat-overlay';
        chatOverlay.style.cssText = `
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          height: 250px;
          background: rgba(0, 0, 0, 0.95);
          z-index: 2000;
          display: flex;
          flex-direction: column;
          animation: slideUp 0.3s ease-out;
        `;
        
        const chatHeader = document.createElement('div');
        chatHeader.style.cssText = `
          padding: 10px;
          background: rgba(255, 255, 255, 0.1);
          display: flex;
          justify-content: space-between;
          align-items: center;
        `;
        
        const chatTitle = document.createElement('span');
        chatTitle.textContent = 'Chat';
        chatTitle.style.color = 'white';
        chatHeader.appendChild(chatTitle);
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '‚úï';
        closeBtn.style.cssText = `
          background: none;
          border: none;
          color: white;
          font-size: 24px;
          padding: 5px;
        `;
        closeBtn.onclick = () => chatOverlay.remove();
        chatHeader.appendChild(closeBtn);
        
        const chatMessages = document.createElement('div');
        chatMessages.style.cssText = `
          flex: 1;
          overflow-y: auto;
          padding: 10px;
          color: white;
          font-size: 14px;
        `;
        
        // Copy existing messages if any
        if (window.gameScene && window.gameScene.chatHistory) {
          window.gameScene.chatHistory.forEach(msg => {
            const msgDiv = document.createElement('div');
            msgDiv.style.marginBottom = '5px';
            msgDiv.innerHTML = msg;
            chatMessages.appendChild(msgDiv);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        const inputContainer = document.createElement('div');
        inputContainer.style.cssText = `
          display: flex;
          padding: 10px;
          gap: 10px;
          background: rgba(255, 255, 255, 0.05);
        `;
        
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Type a message...';
        input.style.cssText = `
          flex: 1;
          padding: 10px;
          background: rgba(255, 255, 255, 0.1);
          border: 1px solid rgba(255, 255, 255, 0.2);
          color: white;
          border-radius: 20px;
          font-size: 16px;
        `;
        
        const sendBtn = document.createElement('button');
        sendBtn.textContent = '‚û§';
        sendBtn.style.cssText = `
          padding: 10px 20px;
          background: #4CAF50;
          color: white;
          border: none;
          border-radius: 20px;
          font-size: 18px;
        `;
        
        const sendMessage = () => {
          const text = input.value.trim();
          if (text && window.gameScene) {
            window.gameScene.sendChatMessage(text);
            input.value = '';
          }
        };
        
        sendBtn.onclick = sendMessage;
        input.onkeypress = (e) => {
          if (e.key === 'Enter') sendMessage();
        };
        
        inputContainer.appendChild(input);
        inputContainer.appendChild(sendBtn);
        
        chatOverlay.appendChild(chatHeader);
        chatOverlay.appendChild(chatMessages);
        chatOverlay.appendChild(inputContainer);
        
        document.body.appendChild(chatOverlay);
        
        // Auto-focus input
        setTimeout(() => input.focus(), 100);
        
        // Add slide up animation
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
          }
        `;
        document.head.appendChild(style);
      }
      
      setupTouchAiming() {
        let aimActive = false;
        let shootOnTap = true;
        
        document.addEventListener('touchstart', (e) => {
          const touch = e.touches[0];
          const target = document.elementFromPoint(touch.clientX, touch.clientY);
          
          // Only aim if not touching a control
          if (!target.closest('#mobile-overlay')) {
            aimActive = true;
            
            // Shoot on tap if not dragging
            if (shootOnTap && window.gameScene && window.gameScene.playerSprite && !window.gameScene.playerSprite.isDead) {
              this.buttons.shoot = true;
              setTimeout(() => {
                this.buttons.shoot = false;
              }, 100);
            }
          }
        });
        
        document.addEventListener('touchmove', (e) => {
          if (!aimActive || !window.gameScene || !window.gameScene.playerSprite) return;
          
          const touch = e.touches[0];
          const canvas = document.querySelector('canvas');
          if (!canvas) return;
          
          const rect = canvas.getBoundingClientRect();
          const x = (touch.clientX - rect.left) / rect.width * canvas.width;
          const y = (touch.clientY - rect.top) / rect.height * canvas.height;
          
          const camera = window.gameScene.cameras.main;
          const worldPoint = camera.getWorldPoint(x, y);
          
          const player = window.gameScene.playerSprite;
          const angle = Math.atan2(worldPoint.y - player.y, worldPoint.x - player.x);
          
          if (window.gameScene.multiplayer) {
            window.gameScene.multiplayer.setAimAngle(angle);
          }
        });
        
        document.addEventListener('touchend', () => {
          aimActive = false;
        });
      }
      
      startUpdateLoop() {
        setInterval(() => {
          if (window.gameScene && window.gameScene.playerSprite) {
            const player = window.gameScene.playerSprite;
            
            // Update health
            const healthPercent = (player.health / 100) * 100;
            document.getElementById('health-fill').style.width = healthPercent + '%';
            document.getElementById('health-text').textContent = player.health;
            
            // Update weapon
            const weapon = (player.currentWeapon || 'fist').toUpperCase();
            document.getElementById('weapon-name').textContent = weapon;
            
            // Update ammo
            const ammo = player.ammo === undefined || player.ammo === -1 ? '‚àû' : player.ammo;
            document.getElementById('ammo-count').textContent = ammo;
          }
        }, 100);
      }
    }
    
    // Initialize controls
    window.mobileControls = new MobileControls();
    
    // Import and modify the game
    import('./js/main.js').then(() => {
      console.log('Game loaded for mobile');
      
      // Wait for game scene
      const waitForGame = setInterval(() => {
        if (window.GameScene) {
          clearInterval(waitForGame);
          
          // Override LoginScene to hide mobile overlay
          if (window.LoginScene) {
            const originalLoginCreate = window.LoginScene.prototype.create;
            window.LoginScene.prototype.create = function() {
              originalLoginCreate.call(this);
              // Hide mobile overlay during login
              document.getElementById('mobile-overlay').classList.remove('active');
            };
          }
          
          // Override create to remove desktop UI
          const originalCreate = window.GameScene.prototype.create;
          window.GameScene.prototype.create = function() {
            originalCreate.call(this);
            
            // Store reference
            window.gameScene = this;
            
            // Show mobile controls
            document.getElementById('mobile-overlay').classList.add('active');
            
            // Remove UI width offset for mobile
            const gameSize = this.scale.gameSize;
            this.cameras.main.setViewport(0, 0, gameSize.width, gameSize.height);
            
            // Slightly zoom out for better visibility
            this.cameras.main.setZoom(0.9);
            
            // Hide any desktop UI that might appear
            setTimeout(() => {
              const uiElements = document.querySelectorAll('#gameUI, .game-ui-panel, #bottom-ui-panel, .ui-panel');
              uiElements.forEach(el => el.style.display = 'none');
              
              // Also hide the desktop chat container
              const chatContainer = document.getElementById('chat-container');
              if (chatContainer) chatContainer.style.display = 'none';
            }, 100);
          };
          
          // Override resize to maintain full viewport
          const originalResize = window.GameScene.prototype.resize;
          if (originalResize) {
            window.GameScene.prototype.resize = function(gameSize) {
              this.cameras.main.setViewport(0, 0, gameSize.width, gameSize.height);
            };
          }
          
          // Override update for mobile controls
          const originalUpdate = window.GameScene.prototype.update;
          window.GameScene.prototype.update = function(time, delta) {
            // Inject mobile controls
            if (window.mobileControls) {
              const m = window.mobileControls.movement;
              const b = window.mobileControls.buttons;
              
              this.cursors.left.isDown = m.x < -0.3;
              this.cursors.right.isDown = m.x > 0.3;
              this.cursors.up.isDown = m.y < -0.3;
              this.cursors.down.isDown = m.y > 0.3;
              // Make joystick up also trigger jump
              this.cursors.space.isDown = b.jump || m.y < -0.7;
              
              if (this.playerSprite && !this.playerSprite.isDead) {
                this.playerSprite.isShooting = b.shoot;
                
                // Handle build mode
                if (b.build && !this.buildMode) {
                  this.toggleBuildMode();
                } else if (!b.build && this.buildMode) {
                  this.toggleBuildMode();
                }
              }
            }
            
            originalUpdate.call(this, time, delta);
          };
        }
      }, 100);
    });
    
    // Prevent iOS bounce
    document.body.addEventListener('touchmove', (e) => {
      e.preventDefault();
    }, { passive: false });
  </script>
</body>
</html>